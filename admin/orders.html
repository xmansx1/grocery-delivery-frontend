<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø§Ù„Ù…Ø´Ø±Ù</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .status-badge {
        padding: 5px 10px;
        border-radius: 10px;
        color: #fff;
        font-size: 0.85rem;
      }
      .Ø¬Ø¯ÙŠØ¯ { background-color: #2196f3; }
      .Ø¬Ø§Ø±ÙŠ { background-color: #ff9800; }
      .ØªÙˆØµÙŠÙ„ { background-color: #9c27b0; }
      .ØªÙ… { background-color: #4caf50; }
      .Ù…Ù„ØºÙŠ { background-color: #f44336; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="dashboard.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</a>
        <button class="btn btn-outline-light" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </nav>

    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
        <select id="storeFilter" class="form-select w-auto" onchange="filterByStore()">
          <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª</option>
        </select>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered bg-white shadow align-middle">
          <thead class="table-dark">
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</th>
              <th>Ø§Ù„Ù…Ø­Ù„</th>
              <th>Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
              <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/env.js"></script>
    <script>
      const adminToken = localStorage.getItem("admin_token");
      if (!adminToken) location.href = "login.html";

      const headers = { Authorization: `Bearer ${adminToken}` };
      let allOrders = [];

      function logout() {
        localStorage.clear();
        location.href = "login.html";
      }

      async function fetchOrders() {
        try {
          const res = await fetch(`${API_BASE_URL}/orders`, { headers });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª");
          if (!Array.isArray(data)) throw new Error("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
          allOrders = data;
          renderOrders(allOrders);
        } catch (err) {
          alert("ğŸš« " + err.message);
        }
      }

      async function fetchStores() {
        try {
          const res = await fetch(`${API_BASE_URL}/stores`, { headers });
          const stores = await res.json();
          const select = document.getElementById("storeFilter");
          stores.forEach(store => {
            const option = document.createElement("option");
            option.value = store.name;
            option.textContent = store.name;
            select.appendChild(option);
          });
        } catch (err) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª:", err);
        }
      }

      function filterByStore() {
        const selected = document.getElementById("storeFilter").value;
        const filtered = selected === "all"
          ? allOrders
          : allOrders.filter(o => o.store_name === selected);
        renderOrders(filtered);
      }

      function renderOrders(orders) {
        const table = document.getElementById("ordersTable");
        table.innerHTML = Array.isArray(orders)
          ? orders.map(order => `
              <tr>
                <td>${order.customer_name}</td>
                <td>${order.customer_phone}</td>
                <td>${order.store_name || "-"}</td>
                <td>${order.order_text}</td>
                <td>${order.notes || "-"}</td>
                <td>
                  <a class="btn btn-sm btn-outline-primary" target="_blank"
                    href="https://maps.google.com/?q=${order.lat},${order.lng}">
                    Ø¹Ø±Ø¶
                  </a>
                </td>
                <td>${order.rider_name || "-"}</td>
                <td>${order.amount || "-"} Ø±ÙŠØ§Ù„</td>
                <td><span class="status-badge ${getStatusClass(order.status)}">
                  ${order.status}
                </span></td>
                <td>
                  <select class="form-select form-select-sm"
                          onchange="changeStatus(${order.id}, this.value)">
                    <option disabled selected>ØªØºÙŠÙŠØ±</option>
                    <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
                    <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
                    <option value="Ø®Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„">Ø®Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„</option>
                    <option value="ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                    <option value="ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡">ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡</option>
                  </select>
                </td>
              </tr>
            `).join("")
          : "<tr><td colspan='10' class='text-center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
      }

      function getStatusClass(status) {
        if (status.includes("Ø¬Ø¯ÙŠØ¯")) return "Ø¬Ø¯ÙŠØ¯";
        if (status.includes("ØªØ¬Ù‡ÙŠØ²")) return "Ø¬Ø§Ø±ÙŠ";
        if (status.includes("ØªÙˆØµÙŠÙ„")) return "ØªÙˆØµÙŠÙ„";
        if (status.includes("ØªÙ…")) return "ØªÙ…";
        if (status.includes("Ø¥Ù„ØºØ§Ø¡")) return "Ù…Ù„ØºÙŠ";
        return "";
      }

      async function changeStatus(orderId, status) {
        try {
          await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              ...headers,
            },
            body: JSON.stringify({ status }),
          });
          fetchOrders();
        } catch (err) {
          alert("âŒ Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©");
        }
      }

      window.onload = async () => {
        await fetchStores();
        await fetchOrders();
      };
    </script>
  </body>
</html>
